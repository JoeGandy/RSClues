{"version":3,"sources":["../../../src/internal-plugins/webpack-theme-component-shadowing/index.js"],"names":["path","require","debug","fs","module","exports","GatsbyThemeComponentShadowingResolverPlugin","constructor","projectRoot","themes","apply","resolver","plugin","request","callback","matchingThemes","filter","name","includes","join","length","Error","theme","split","component","builtComponentPath","resolveComponentPath","matchingTheme","doResolve","resolvedComponentPath","resolve","directory","query","ogThemes","t","cache","concat","map","aTheme","dirname","dir","find","possibleComponentPath","readdirSync","e","exists","filepath","ext","extname","filenameWithoutExtension","basename"],"mappings":"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","sourcesContent":["const path = require(`path`)\nconst debug = require(`debug`)(`gatsby:component-shadowing`)\nconst fs = require(`fs`)\n\nmodule.exports = class GatsbyThemeComponentShadowingResolverPlugin {\n  cache = {}\n\n  constructor({ projectRoot, themes }) {\n    debug(`themes list`, themes)\n    this.themes = themes\n    this.projectRoot = projectRoot\n  }\n\n  apply(resolver) {\n    resolver.plugin(`relative`, (request, callback) => {\n      // find out which theme's src/components dir we're requiring from\n      const matchingThemes = this.themes.filter(name =>\n        request.path.includes(path.join(name, `src`))\n      )\n      // 0 matching themes happens a lot fo rpaths we don't want to handle\n      // > 1 matching theme means we have a path like\n      //   `gatsby-theme-blog/src/components/gatsby-theme-something/src/components`\n      if (matchingThemes.length > 1) {\n        throw new Error(\n          `Gatsby can't differentiate between themes ${matchingThemes.join(\n            ` and `\n          )} for path ${request.path}`\n        )\n      }\n      if (matchingThemes.length !== 1) {\n        return callback()\n      }\n      // theme is the theme package from which we're requiring the relative component\n      const [theme] = matchingThemes\n      // get the location of the component relative to src/\n      const [, component] = request.path.split(path.join(theme, `src`))\n\n      const builtComponentPath = this.resolveComponentPath({\n        matchingTheme: theme,\n        themes: this.themes,\n        component,\n        projectRoot: this.projectRoot,\n      })\n\n      if (!builtComponentPath) {\n        return resolver.doResolve(\n          `describedRelative`,\n          request,\n          null,\n          {},\n          callback\n        )\n      }\n      const resolvedComponentPath = require.resolve(builtComponentPath)\n      // this callbackends the resolver fallthrough chain.\n      return callback(null, {\n        directory: request.directory,\n        path: resolvedComponentPath,\n        query: request.query,\n        request: ``,\n      })\n    })\n  }\n\n  // check the cache, the user's project, and finally the theme files\n  resolveComponentPath({\n    matchingTheme: theme,\n    themes: ogThemes,\n    component,\n    projectRoot,\n  }) {\n    // don't include matching theme in possible shadowing paths\n    const themes = ogThemes.filter(t => t !== theme)\n    if (!this.cache[`${theme}-${component}`]) {\n      this.cache[`${theme}-${component}`] = [\n        path.join(path.resolve(`.`), `src`, theme),\n      ]\n        .concat(\n          themes.map(aTheme =>\n            path.join(path.dirname(require.resolve(aTheme)), `src`, theme)\n          )\n        )\n        .map(dir => path.join(dir, component))\n        .find(possibleComponentPath => {\n          debug(`possibleComponentPath`, possibleComponentPath)\n          let dir\n          try {\n            // we use fs/path instead of require.resolve to work with\n            // TypeScript and alternate syntaxes\n            dir = fs.readdirSync(path.dirname(possibleComponentPath))\n          } catch (e) {\n            return false\n          }\n          const exists = dir\n            .map(filepath => {\n              const ext = path.extname(filepath)\n              const filenameWithoutExtension = path.basename(filepath, ext)\n              return filenameWithoutExtension\n            })\n            .includes(path.basename(possibleComponentPath))\n          return exists\n        })\n    }\n\n    return this.cache[`${theme}-${component}`]\n  }\n}\n"],"file":"index.js"}